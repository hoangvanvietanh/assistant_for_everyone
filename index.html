<!doctype html>
<html lang="en">

<head>
  <title>Title</title>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <script src="./dist/face-api.js"></script>
  <script src="./js/commons.js"></script>
  <script src="./js/faceDetectionControls.js"></script>
  <link rel="stylesheet" href="./css/styles.css">
  <link rel="stylesheet" href="./css/materialize.css">

  <link rel="stylesheet" href="./css/displaytime.css">

  <script type="text/javascript" src="./js/jquery-2.1.1.min.js"></script>
  <script src="./js/materialize.min.js"></script>
  <script src="./js/chart.min.js"></script>
</head>

<body>
  <div class="progress" id="loader">
    <div class="indeterminate"></div>
  </div>
  <div class="container-fluid">
    <div class="row" style="min-height: 90vh;padding: 15px;">
      <div class="col-sm-6" style="background-color: antiquewhite;">
        <div class="row">
          <div class="col-sm-4">
            <button style="width: 100%;" type="button" id="btnShowWebcam" onclick="showWebcam()"
              class="btn btn-primary">Hiển thị webcam</button>
          </div>
          <div class="col-sm-4">
            <button style="width: 100%;" type="button" onclick="setFirstPosition()" class="btn btn-primary">Lấy vị trí
              chuẩn</button>
          </div>
          <div class="col-sm-4">
            <button style="width: 100%;" type="button" onclick="" class="btn btn-primary">Lấy vị trí chuẩn</button>
          </div>
        </div>

        <div class="row">
          <div class="col-sm-12">
            <video onloadedmetadata="onPlay(this)" width="0px" id="inputVideo" autoplay muted playsinline></video>
            <canvas id="overlay" />
          </div>

        </div>
      </div>
      <div class="col-sm-6" style="background-color: azure;">
        <!---Của mày ở đây nè Việt Anh-->
        <div class="col-sm-12 text-center">
          <h4>Bảng điều khiển</h4>
        </div>
        <div class="row">
          <canvas id="chLine"></canvas>
        </div>
        <!--Kết thúc ở đây-->


        <div class="row">
          <div class="col-sm-6">
            <label for="countDownId">Thời gian còn lại:</label>
            <div id="countDownId"></div>


          </div>
          <div class="col-sm-6">
            <label for="shitDownId">Thời gian ngồi:</label>

            <div id="shitDownId"></div>

          </div>
          <div class="col-sm-8">
            <strong>
              <p id="time"></p>
            </strong>
          </div>
        </div>


        <div class="row">

        </div>

        <!-- Start thời gian nghỉ ngơi  -->
        <div class="row">
          <div style="text-align: center; font-family: tahoma;" class="col-sm-12">
            <h5>Setting</h5>
          </div>
          <form class="row" onsubmit="return formSubmit()">
            <div class="col-sm-4">
              <label for="timeRelax">Thời gian nghỉ: <span id="valueTimeRelax"></span> </label>
            </div>
            <div class="col-sm-8">
              <input type="range" name="timeRelax" id="timeRelax" min="1" max="1000" value="1"
                onchange="onChangeTimeRelax(this.value)">
            </div>
            <div class="col-sm-4">
              <label for="wrongTime">Thời gian ngồi sai tư thế: <span id="valueWrongTime"></span> </label>
            </div>
            <div class="col-sm-8">
              <input type="range" name="wrongTime" id="wrongTime" min="1" max="1000" value="1"
                onchange="onChangeWrongTime(this.value)">
            </div>
            <div class="col-sm-4">
              <label for="bonusSecond">Khi cười cộng thêm giây: <span id="valueBonusSecond"></span></label>
            </div>
            <div class="col-sm-8">
              <input type="range" name="bonusSecond" id="bonusSecond" min="1" max="1000" value="1"
                onchange="onChangeBonusSecond(this.value)">
            </div>
            <div class="col-md-12">
              <label for="mucDo" class="form-label">Mức độ</label>
              <select id="mucDo" class="form-control" name="mucDo">
                <option value="1">Thấp</option>
                <option value="2">Trung bình</option>
                <option value="3">Quan trọng</option>
                <option value="4">Nghiêm trọng</option>
              </select>
            </div>


            <div class="col-12" style="margin-top: 10px;">
              <button type="submit" class="btn btn-primary">Lưu </button>
            </div>
          </form>

        </div>
        <!-- End thời gian nghỉ ngơi  -->


      </div>
    </div>
  </div>

  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script> -->
  <script src="./js/popper.min.js"></script>
  <script src="./js/bootstrap.min.js"></script>
  <script src="./js/timer.js"></script>
  <script>
    // Start Edit --Thương
    function onChangeTimeRelax(value) {
      console.log('value1 :>> ', value);
      document.getElementById('valueTimeRelax').innerHTML = value + "ph"
    }
    function onChangeWrongTime(value) {
      console.log('value2 :>> ', value);
      document.getElementById('valueWrongTime').innerHTML = value + "ph"

    }
    function onChangeBonusSecond(value) {
      console.log('value3 :>> ', value);
      document.getElementById('valueBonusSecond').innerHTML = value + "ph"
    }
    function formSubmit() {
      let timeRelax = document.getElementById("timeRelax").value
      let wrongTime = document.getElementById("wrongTime").value
      let bonusSecond = document.getElementById("bonusSecond").value
      let mucDo = document.getElementById("mucDo").value
      console.log('timeRelax :>> ', timeRelax);
    }
    // End Edit --Thương
    var chartData = {
      labels: ["S", "M", "T", "W", "T", "F", "S"],
      datasets: [{
        data: [589, 445, 483, 503, 689, 692, 634],
      },
      {
        data: [639, 465, 493, 478, 589, 632, 674],
      }]
    };
    /* chart.js chart examples */

    // chart colors
    var colors = ['#007bff', '#28a745', '#333333', '#c3e6cb', '#dc3545', '#6c757d'];

    /* large line chart */
    var chLine = document.getElementById("chLine");
    var chartData = {
      labels: ["T2", "T3", "T4", "T5", "T6", "T7", "CN"],
      datasets: [{
        label: 'Số lần ngồi sai',
        data: [5, 2, 11, 40, 20, 23, 12],
        backgroundColor: 'transparent',
        borderColor: colors[0],
        borderWidth: 4,
        pointBackgroundColor: colors[0]
      },
      {
        label: 'Số lần nghỉ',
        data: [20, 10, 30, 22, 18, 5, 2],
        backgroundColor: colors[3],
        borderColor: colors[1],
        borderWidth: 4,
        pointBackgroundColor: colors[1]
      }]
    };

    if (chLine) {
      new Chart(chLine, {
        type: 'line',
        data: chartData,
        options: {
          scales: {
            yAxes: [{
              ticks: {
                beginAtZero: false
              }
            }]
          },
          legend: {
            display: false
          }
        }
      });
    }
  </script>
  <script>
    let countTime = 0
    let countTimeNotification = 0
    let forwardTimes = []
    let positionFirst = 0
    let positionMove = 0
    let withBoxes = true
    let isShowWebcam = false
    var milisec;
    milisec = miliseconds(0, 2, 0);
    console.log('milisec: ' + milisec)
    var countTimeDown = milisec;

    function showWebcam() {
      isShowWebcam = !isShowWebcam
      if (isShowWebcam) {
        document.getElementById('btnShowWebcam').innerHTML = 'Ẩn Webcam'
        document.getElementById('inputVideo').style.width = '610px'
        document.getElementById('inputVideo').style.height = '480px'
      } else {
        document.getElementById('btnShowWebcam').innerHTML = 'Hiển thị Webcam'
        document.getElementById('inputVideo').style.width = '0px'
        document.getElementById('inputVideo').style.height = '0px'
      }

    }

    function getPositionFirst() {
      return positionFirst + 20
    }

    function setFirstPosition() {
      positionFirst = positionMove
    }

    function onChangeHideBoundingBoxes(e) {
      withBoxes = !$(e.target).prop('checked')
    }

    function updateTimeStats(timeInMs) {
      forwardTimes = [timeInMs].concat(forwardTimes).slice(0, 30)
      const avgTimeInMs = forwardTimes.reduce((total, t) => total + t) / forwardTimes.length
      $('#time').val(`${Math.round(avgTimeInMs)} ms`)
      $('#fps').val(`${faceapi.utils.round(1000 / avgTimeInMs)}`)
    }

    async function onPlay() {
      const videoEl = $('#inputVideo').get(0)

      if (videoEl.paused || videoEl.ended || !isFaceDetectionModelLoaded())
        return setTimeout(() => onPlay())


      const options = getFaceDetectorOptions()

      const ts = Date.now()

      const result = await faceapi.detectSingleFace(videoEl, options).withFaceLandmarks()

      updateTimeStats(Date.now() - ts)
      //cao giảm, dưới tăng max 370
      //trái giảm, phải tăng max 450 -20
      if (result) {
        const canvas = $('#overlay').get(0)
        const dims = faceapi.matchDimensions(canvas, videoEl, true)
        const resizedResult = faceapi.resizeResults(result, dims)
        //console.log(result.detection.box.x +':', result.detection.box.y)
        let x = result.detection.box.x;
        let y = result.detection.box.y;
        positionMove = y;
        countTime++
        countTimeDown--
        if (countTime == 500) {
          notifyMe('Nghỉ ngơi tí thôi')
        }
        if (countTimeDown == 0) {
          notifyMe('Nghỉ ngơi tí thôi')
        }
        if (positionFirst !== 0) {
          if (y > positionFirst) {
            if (countTimeNotification >= 50) {
              notifyMe('Ngồi thẳng dậy nào, nhanh nhanh...')
            }
            countTimeNotification++
          }
          if (y < positionFirst) {
            countTimeNotification = 0;
          }
        }

        render()
        if (withBoxes) {
          faceapi.draw.drawDetections(canvas, resizedResult)
        }
        faceapi.draw.drawFaceLandmarks(canvas, resizedResult)
      }

      setTimeout(() => onPlay())
    }

    async function run() {
      // load face detection and face landmark models
      await changeFaceDetector(TINY_FACE_DETECTOR)
      await faceapi.loadFaceLandmarkModel('/')
      changeInputSize(224)

      // try to access users webcam and stream the images
      // to the video element
      const stream = await navigator.mediaDevices.getUserMedia({ video: {} })
      const videoEl = $('#inputVideo').get(0)
      videoEl.srcObject = stream
    }

    function updateResults() { }

    $(document).ready(function () {
      //renderNavBar('#navbar', 'webcam_face_landmark_detection')
      initFaceDetectionControls()
      run()
    })
    function notifyMe(message) {
      countTimeNotification = 0;
      countTime = 0;
      // Let's check if the browser supports notifications
      if (!("Notification" in window)) {
        alert("This browser does not support desktop notification");
      }

      // Let's check whether notification permissions have already been granted
      else if (Notification.permission === "granted") {
        // If it's okay let's create a notification
        var notification = new Notification(message);
      }

      // Otherwise, we need to ask the user for permission
      else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(function (permission) {
          // If the user accepts, let's create a notification
          if (permission === "granted") {
            var notification = new Notification(message);
          }
        });
      }

      // At last, if the user has denied notifications, and you
      // want to be respectful there is no need to bother them any more.
    }

    function render() {
      time.innerHTML = countTime / 1000;
      document.getElementById("baseTimeLabel").innerHTML = formatTime(
        countTimeDown
      );
      setCircleDasharray();
      setRemainingPathColor(countTimeDown);

      if (countTimeDown === 0) {
        onTimesUp();
      }

      document.getElementById("baseTimeLabel1").innerHTML = formatTime(
        countTime / 1000
      );
      setCircleDasharray();
      setRemainingPathColor(countTime / 1000);

      if (countTime / 1000 === 0) {
        onTimesUp();
      }
      console.log('----------------------');
    }

    displayTimeShiwDown("shitDownId", "baseTimerPathRemaining", "baseTimeLabel1", countTime);
    displayTimeShiwDown("countDownId", "baseTimerPathRemaining", "baseTimeLabel", countTimeDown);


    function miliseconds(hrs, min, sec) {
      return (((hrs * 60 * 60) + (min * 60) + sec));
    }
    //startTimer(milisec/1000);
  </script>
</body>

</html>